<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="msvalidate.01" content="09940DFE4C5DA4E85A7117EF7EEC3933">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"acomma.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="在 Canary Release 一文中作者说明了灰度发布的概念和流程   现在我们来看看在 Spring Cloud 技术体系下该如何实现灰度发布？相关的源码在 examples&#x2F;example-cloud。">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud 全链路灰度发布">
<meta property="og:url" content="https://acomma.github.io/2025/03/22/spring-cloud-canary-deployment/index.html">
<meta property="og:site_name" content="逗号的博客">
<meta property="og:description" content="在 Canary Release 一文中作者说明了灰度发布的概念和流程   现在我们来看看在 Spring Cloud 技术体系下该如何实现灰度发布？相关的源码在 examples&#x2F;example-cloud。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://acomma.github.io/2025/03/22/spring-cloud-canary-deployment/canary-release-2.png">
<meta property="article:published_time" content="2025-03-22T13:42:52.000Z">
<meta property="article:modified_time" content="2025-03-22T13:42:52.000Z">
<meta property="article:author" content="逗号">
<meta property="article:tag" content="Spring Cloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://acomma.github.io/2025/03/22/spring-cloud-canary-deployment/canary-release-2.png">


<link rel="canonical" href="https://acomma.github.io/2025/03/22/spring-cloud-canary-deployment/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://acomma.github.io/2025/03/22/spring-cloud-canary-deployment/","path":"2025/03/22/spring-cloud-canary-deployment/","title":"Spring Cloud 全链路灰度发布"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Spring Cloud 全链路灰度发布 | 逗号的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">逗号的博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">这里有一句格言，但我还没想好</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%A0%87%E8%AE%B0%E9%82%A3%E4%BA%9B%E6%9C%8D%E5%8A%A1%E6%98%AF%E7%81%B0%E5%BA%A6%E6%9C%8D%E5%8A%A1%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">如何标记那些服务是灰度服务？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%A0%87%E8%AE%B0%E9%82%A3%E4%BA%9B%E8%AF%B7%E6%B1%82%E6%98%AF%E7%81%B0%E5%BA%A6%E8%AF%B7%E6%B1%82%EF%BC%9F"><span class="nav-number">2.</span> <span class="nav-text">如何标记那些请求是灰度请求？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%81%B0%E5%BA%A6%E8%AF%B7%E6%B1%82%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8%E7%81%B0%E5%BA%A6%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.</span> <span class="nav-text">灰度请求如何调用灰度服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6%E6%9C%8D%E5%8A%A1%E4%B9%8B%E9%97%B4%E7%9A%84%E7%9B%B8%E4%BA%92%E8%B0%83%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">如何实现灰度服务之间的相互调用</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">逗号</p>
  <div class="site-description" itemprop="description">这里是站点描述，但我没有写</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/acomma" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;acomma" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:acomma@yeah.net" title="E-Mail → mailto:acomma@yeah.net" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://acomma.github.io/2025/03/22/spring-cloud-canary-deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="逗号">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逗号的博客">
      <meta itemprop="description" content="这里是站点描述，但我没有写">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Spring Cloud 全链路灰度发布 | 逗号的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Cloud 全链路灰度发布
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-03-22 21:42:52" itemprop="dateCreated datePublished" datetime="2025-03-22T21:42:52+08:00">2025-03-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>在 <a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CanaryRelease.html">Canary Release</a> 一文中作者说明了灰度发布的概念和流程</p>
<img src="/2025/03/22/spring-cloud-canary-deployment/canary-release-2.png" class="">

<p>现在我们来看看在 Spring Cloud 技术体系下该如何实现灰度发布？相关的源码在 <a target="_blank" rel="noopener" href="https://github.com/acomma/examples/tree/main/example-cloud">examples&#x2F;example-cloud</a>。</p>
<span id="more"></span>

<h2 id="如何标记那些服务是灰度服务？"><a href="#如何标记那些服务是灰度服务？" class="headerlink" title="如何标记那些服务是灰度服务？"></a>如何标记那些服务是灰度服务？</h2><p>Eureka 服务注册中心支持元数据</p>
<blockquote>
<p>Additional metadata can be added to the instance registration in the eureka.instance.metadataMap, and this metadata is accessible in the remote clients. In general, additional metadata does not change the behavior of the client, unless the client is made aware of the meaning of the metadata. There are a couple of special cases, described later in this document, where Spring Cloud already assigns meaning to the metadata map.</p>
<p>引用自 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-netflix/reference/spring-cloud-netflix.html#_eureka_metadata_for_instances_and_clients">Eureka Metadata for Instances and Clients</a></p>
</blockquote>
<p>因此在发布服务时在 <code>application.yml</code> 文件中增加元数据 <code>eureka.instance.metadata-map.canary</code>，值为 <code>true</code> 时表示该服务是灰度服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">metadata-map:</span></span><br><span class="line">      <span class="attr">canary:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="如何标记那些请求是灰度请求？"><a href="#如何标记那些请求是灰度请求？" class="headerlink" title="如何标记那些请求是灰度请求？"></a>如何标记那些请求是灰度请求？</h2><p>标记一个请求是灰度请求还是正常请求有很多种方式，比如根据 IP 地址、用户 ID、时区等等来标记。可以在前端发起请求时打标记，也可以在后端入口处打标记。目前我们选择在网关根据登录用户名来标记请求是否为灰度请求，具体实现见 <a target="_blank" rel="noopener" href="https://github.com/acomma/examples/blob/main/example-cloud/example-gateway/src/main/java/com/example/gateway/filter/CustomRequestFilter.java">CustomRequestFilter.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">    <span class="comment">// 省略了...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> reactiveJwtDecoder.decode(accessToken)</span><br><span class="line">            .flatMap(jwt -&gt; &#123;</span><br><span class="line">                <span class="type">ServerHttpRequest</span> <span class="variable">newRequest</span> <span class="operator">=</span> exchange.getRequest().mutate()</span><br><span class="line">                        <span class="comment">// 放入请求头的可以是从 JWT 中获取的用户信息，这里只是简单的把 Subject 信息放进去</span></span><br><span class="line">                        .header(<span class="string">&quot;X-User&quot;</span>, jwt.getSubject())</span><br><span class="line">                        .header(<span class="string">&quot;X-Canary&quot;</span>, isCanary(jwt.getSubject()))</span><br><span class="line">                        .build();</span><br><span class="line">                <span class="type">ServerWebExchange</span> <span class="variable">newExchange</span> <span class="operator">=</span> exchange.mutate().request(newRequest).build();</span><br><span class="line">                <span class="keyword">return</span> chain.filter(newExchange);</span><br><span class="line">            &#125;)</span><br><span class="line">            .onErrorResume(throwable -&gt; chain.filter(exchange));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据用户名判断是否进行灰度</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">isCanary</span><span class="params">(String subject)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> String.valueOf(subject != <span class="literal">null</span> &amp;&amp; subject.equals(<span class="string">&quot;alice&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="灰度请求如何调用灰度服务"><a href="#灰度请求如何调用灰度服务" class="headerlink" title="灰度请求如何调用灰度服务"></a>灰度请求如何调用灰度服务</h2><p>Spring Cloud LoadBalancer 允许自定义负载均衡器，参考 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-commons/reference/spring-cloud-commons/loadbalancer.html#switching-between-the-load-balancing-algorithms">Switching between the load-balancing algorithms</a> 和 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-commons/reference/spring-cloud-commons/loadbalancer.html#custom-loadbalancer-configuration">Passing Your Own Spring Cloud LoadBalancer Configuration</a>。而 Spring Cloud Gateway 默认的负载均衡器是 <code>RoundRobinLoadBalancer</code>，它不区分服务是否为灰度服务，为了实现灰度请求调用灰度服务的目的需要参考 <code>RoundRobinLoadBalancer</code> 实现 <a target="_blank" rel="noopener" href="https://github.com/acomma/examples/blob/main/example-cloud/example-gateway/src/main/java/com/example/gateway/loadbalancer/CanaryRoundRobinLoadBalancer.java">CanaryRoundRobinLoadBalancer</a>。在这个负载均衡器里需要做两件事情，第一件事是拿到上一步设置在请求头里的灰度标记</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;Response&lt;ServiceInstance&gt;&gt; <span class="title function_">choose</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">    List&lt;String&gt; candidates = ((RequestDataContext) request.getContext()).getClientRequest().getHeaders().get(<span class="string">&quot;X-Canary&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">canary</span> <span class="operator">=</span> candidates != <span class="literal">null</span> &amp;&amp; !candidates.isEmpty() ? candidates.getFirst() : <span class="string">&quot;false&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略了...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二件事是把灰度服务和正常服务区分开来，这需要用到服务实例的元数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Response&lt;ServiceInstance&gt; <span class="title function_">getInstanceResponse</span><span class="params">(List&lt;ServiceInstance&gt; instances, String canary)</span> &#123;</span><br><span class="line">    List&lt;ServiceInstance&gt; normalInstances = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;ServiceInstance&gt; canaryInstances = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance.getMetadata().get(<span class="string">&quot;canary&quot;</span>) != <span class="literal">null</span> &amp;&amp; instance.getMetadata().get(<span class="string">&quot;canary&quot;</span>).equals(<span class="string">&quot;true&quot;</span>)) &#123;</span><br><span class="line">            canaryInstances.add(instance);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            normalInstances.add(instance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (canary.equals(<span class="string">&quot;true&quot;</span>)) &#123;</span><br><span class="line">        instances = canaryInstances.isEmpty() ? normalInstances : canaryInstances;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        instances = normalInstances.isEmpty() ? canaryInstances : normalInstances;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略了...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了负载均衡器后还需要定义它的配置类，注意这个配置类不要添加 <code>@Configuration</code> 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanaryRoundRobinLoadBalancerClientConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    ReactorLoadBalancer&lt;ServiceInstance&gt; <span class="title function_">randomLoadBalancer</span><span class="params">(Environment environment, LoadBalancerClientFactory loadBalancerClientFactory)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CanaryRoundRobinLoadBalancer</span>(loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class), name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来通过 <code>@LoadBalancerClient</code> 自定义每种服务使用的负载均衡算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LoadBalancerClients(</span></span><br><span class="line"><span class="meta">        value = &#123;</span></span><br><span class="line"><span class="meta">                // 使用 Eureka 作为注册中心时 name 必须与 Eureka 中注册的服务名保持一致，Eureka 在注册服务时会把名称转为大写形式，</span></span><br><span class="line"><span class="meta">                // 具体实现为 org.springframework.cloud.netflix.eureka.InstanceInfoFactory 类的 create 方</span></span><br><span class="line"><span class="meta">                @LoadBalancerClient(name = &quot;EXAMPLE-USER&quot;, configuration = CanaryRoundRobinLoadBalancerClientConfiguration.class),</span></span><br><span class="line"><span class="meta">                @LoadBalancerClient(name = &quot;EXAMPLE-PRODUCT&quot;, configuration = CanaryRoundRobinLoadBalancerClientConfiguration.class),</span></span><br><span class="line"><span class="meta">                @LoadBalancerClient(name = &quot;EXAMPLE-ORDER&quot;, configuration = CanaryRoundRobinLoadBalancerClientConfiguration.class),</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleGatewayApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ExampleGatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何实现灰度服务之间的相互调用"><a href="#如何实现灰度服务之间的相互调用" class="headerlink" title="如何实现灰度服务之间的相互调用"></a>如何实现灰度服务之间的相互调用</h2><p>首先，定义一个 Feign 拦截器将灰度标记在服务之间进行传递，见 <a target="_blank" rel="noopener" href="https://github.com/acomma/examples/blob/main/example-cloud/example-order/src/main/java/com/example/order/interceptor/CustomRequestInterceptor.java">CustomRequestInterceptor.java</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">    <span class="type">ServletRequestAttributes</span> <span class="variable">requestAttributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">    <span class="keyword">if</span> (requestAttributes != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestAttributes.getRequest();</span><br><span class="line">        <span class="comment">// 在实践中这里可以是已授权的用户信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-User&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">            template.header(<span class="string">&quot;X-User&quot;</span>, user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">canary</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;X-Canary&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (canary != <span class="literal">null</span>) &#123;</span><br><span class="line">            template.header(<span class="string">&quot;X-Canary&quot;</span>, canary);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其次，定义灰度负载均衡器和它的配置，这部分和网关一样，不再重复。</p>
<p>最后，通过 <code>@LoadBalancerClient</code> 自定义每种服务使用的负载均衡算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LoadBalancerClients(</span></span><br><span class="line"><span class="meta">        value = &#123;</span></span><br><span class="line"><span class="meta">                // 这里的名字得用小写形式</span></span><br><span class="line"><span class="meta">                @LoadBalancerClient(name = &quot;example-user&quot;, configuration = CanaryRoundRobinLoadBalancerClientConfiguration.class),</span></span><br><span class="line"><span class="meta">                @LoadBalancerClient(name = &quot;example-product&quot;, configuration = CanaryRoundRobinLoadBalancerClientConfiguration.class),</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleOrderApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ExampleOrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完~</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Spring-Cloud/" rel="tag"># Spring Cloud</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/01/23/why-does-spring-boot-application-not-exit-after-the-main-method-is-executed/" rel="prev" title="为什么 Spring Boot 应用在 main 方法执行完成后不会退出？">
                  <i class="fa fa-angle-left"></i> 为什么 Spring Boot 应用在 main 方法执行完成后不会退出？
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">逗号</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
